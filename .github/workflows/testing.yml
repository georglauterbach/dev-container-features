---
name: Testing

on: # yamllint disable-line rule:truthy
  workflow_dispatch:
  pull_request:
    paths:
      - src/**
      - test/**
      - .github/workflows
  push:
    branches: [main]
    paths:
      - src/**
      - test/**
      - .github/workflows

defaults:
  run:
    shell: bash

permissions:
  contents: read

jobs:
  auto-generated:
    name: Auto-Generated
    runs-on: ubuntu-latest

    strategy:
      matrix:
        baseImage:
          - ubuntu:24.04
        feature:
          - lang-rust

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Install latest devcontainer CLI
        run: npm install -g @devcontainers/cli

      - name: Generating tests against ${{ matrix.baseImage }}
        run: >
          devcontainer features test
          -f ${{ matrix.feature }}
          -i ${{ matrix.baseImage }}
          --skip-duplicated
          --skip-scenarios
          .

  scenarios:
    name: Scenarios
    runs-on: ubuntu-latest

    strategy:
      matrix:
        baseImage:
          - ubuntu:24.04
        feature:
          - lang-rust

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Install latest devcontainer CLI
        run: npm install -g @devcontainers/cli

      - name: Generating tests scenarios
        run: devcontainer features test -f ${{ matrix.feature }} -i ${{ matrix.baseImage }} --skip-duplicated --skip-autogenerated .
